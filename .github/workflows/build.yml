name: CI

on: [push, pull_request]

jobs:
  build-Linux:

    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4.0.0

    - name: Install system dependencies
      run: >
        sudo apt-get update;
        sudo apt-get --no-install-recommends install python3-dev python3-pytest

    - name: Build
      run: |
        python -m pip install --upgrade pip;
        pip install '.[test]' -Csetup-args=-Dtesting=true --prefix=install-prefix
      env:
        DEBUG: 1

    - name: Test
      run: |
        ./install-prefix/bin/pymol -ckqy testing/testing.py --run all

  build-Windows:

    runs-on: windows-latest

    env:
      CONDA_ROOT: ${{github.workspace}}\..\tmp\mambaforge
      MAMBAFORGE_EXEC: ${{github.workspace}}\..\tmp\mambaforge.exe

    steps:
    - uses: actions/checkout@v4.0.0
    - name: Download miniconda
      shell: cmd
      run: |-
        if not exist %CONDA_ROOT% mkdir %CONDA_ROOT%
        curl -L -o %MAMBAFORGE_EXEC% https://github.com/conda-forge/miniforge/releases/download/24.3.0-0/Mambaforge-24.3.0-0-Windows-x86_64.exe
        start /wait %MAMBAFORGE_EXEC% /S /D=%CONDA_ROOT%

    - name: Set up Miniconda
      shell: cmd
      run: |-
        CALL %CONDA_ROOT%\\Scripts\\activate.bat
        conda install -y -c conda-forge -c python glew pytest

    - name: Conda info
      shell: cmd
      run: |-
        CALL %CONDA_ROOT%\\Scripts\\activate.bat
        conda info

    - name: Get additional sources
      shell: cmd
      run: |
        git clone --depth 1 https://github.com/rcsb/mmtf-cpp.git
        cp -R mmtf-cpp/include/mmtf* %CONDA_ROOT%/Library/include/
        git clone --depth 1 --single-branch --branch cpp_master https://github.com/msgpack/msgpack-c.git
        cp -R msgpack-c/include/msgpack* %CONDA_ROOT%/Library/include/

    - name: Build PyMOL
      shell: cmd
      run: |
        CALL %CONDA_ROOT%\\Scripts\\activate.bat
        pip install . -Csetup-args=-Dtesting=true --prefix=%GITHUB_WORKSPACE%\\install-prefix

    - name: Test
      shell: cmd
      run: |
        CALL %CONDA_ROOT%\\Scripts\\activate.bat
        %GITHUB_WORKSPACE%\\install-prefix\\Scripts\\pymol.bat -ckqy testing\\testing.py --run all

  build-MacOS:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4.0.0
    - name: Build PyMOL
      run: |-
        export MACOSX_DEPLOYMENT_TARGET=12.0
        pip install '.[test]' -Csetup-args=-Dtesting=true --prefix=${GITHUB_WORKSPACE}/install-prefix

    - name: Test
      run: |-
        ${GITHUB_WORKSPACE}/install-prefix/bin/pymol -ckqy testing/testing.py --run all
